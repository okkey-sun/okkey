<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ†ã‚¹ãƒˆçµæœ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 800px; margin-top: 50px; }
        .card { margin-bottom: 20px; }
        .choice-item {
            padding: 8px 12px;
            border-radius: 5px;
            margin-bottom: 5px;
            border: 1px solid #dee2e6;
            background-color: #fff;
            display: flex;
            align-items: center;
        }
        .choice-item.selected { background-color: #e0f7fa; border-color: #00bcd4; }
        .choice-item.correct { background-color: #d4edda; border-color: #28a745; }
        .choice-item.incorrect { background-color: #f8d7da; border-color: #dc3545; }
        .choice-label { flex-grow: 1; padding-left: 5px; }
        .icon-container { width: 25px; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        .status-icon { font-size: 1.2em; }
        .status-icon.correct { color: #28a745; }
        .status-icon.incorrect { color: #dc3545; }
        .custom-rationale-bg, .custom-reference-bg { background-color: #f5f5f5; }
        
        /* AIè§£èª¬ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .ai-response-area {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
            display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center mb-4">ãƒ†ã‚¹ãƒˆçµæœ</h2>

        <div class="alert alert-info text-center">
            <h3>{{ total }}å•ä¸­ <span class="correct-answer">{{ score }}</span> å•æ­£è§£ï¼</h3>
        </div>

        {% for res in results %}
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    å•é¡Œ {{ loop.index }}
                    {% if res.is_correct %}
                        <span class="badge bg-success">æ­£è§£</span>
                    {% else %}
                        <span class="badge bg-danger">ä¸æ­£è§£</span>
                    {% endif %}
                </h5>
                <p class="card-text">{{ res.question.question }}</p>

                <div class="mb-3">
                    {% set all_choices = [res.question.choice1, res.question.choice2, res.question.choice3, res.question.choice4] %}
                    {% for choice_text in all_choices %}
                        {% set current_choice_index = loop.index %}
                        {% set is_selected = (current_choice_index == res.selected_choice_index) %}
                        {% set is_correct_choice = (current_choice_index == res.correct_choice_index) %}

                        <div class="choice-item {% if is_selected and res.is_correct %}correct{% elif is_selected and not res.is_correct %}incorrect{% elif is_correct_choice and not is_selected %}correct{% endif %}">
                            <div class="icon-container">
                                {% if is_selected and res.is_correct %}
                                    <span class="status-icon correct">âœ”</span>
                                {% elif is_selected and not res.is_correct %}
                                    <span class="status-icon incorrect">âœ–</span>
                                {% elif is_correct_choice %}
                                    <span class="status-icon correct">âœ”</span>
                                {% endif %}
                            </div>
                            <span class="choice-label">{{ choice_text }}</span>
                        </div>
                    {% endfor %}
                </div>

                {% if res.question.rationale %}
                <div class="custom-rationale-bg alert mt-3">
                    <strong>è§£èª¬:</strong><br>
                    {{ res.question.rationale }}
                </div>
                {% endif %}

                <div class="mt-2 mb-3">
                    <button class="btn btn-warning btn-sm" onclick="askAI(this, {{ loop.index0 }})">
                        âœ¨ AIè¬›å¸«ã«è©³ã—ãèã
                    </button>
                    <div id="ai-response-{{ loop.index0 }}" class="ai-response-area alert mt-2">
                        </div>
                </div>

                {% if res.question.reference %}
                <div class="custom-reference-bg alert">
                    <strong>å‚ç…§URL:</strong><br>
                    <a href="{{ res.question.reference }}" target="_blank">{{ res.question.reference }}</a>
                </div>
                {% endif %}
                
                <script type="application/json" id="data-{{ loop.index0 }}">
                    {
                        "question": {{ res.question.question|tojson }},
                        "choices": [{{ res.question.choice1|tojson }}, {{ res.question.choice2|tojson }}, {{ res.question.choice3|tojson }}, {{ res.question.choice4|tojson }}],
                        "correct": {{ res.question.correct }},
                        "rationale": {{ res.question.rationale|tojson }}
                    }
                </script>
            </div>
        </div>
        {% endfor %}

        <div class="text-center">
            <a href="{{ url_for('practice') }}" class="btn btn-primary">ã‚‚ã†ä¸€åº¦ãƒ†ã‚¹ãƒˆã™ã‚‹</a>
            <br><br><a href="/home" class="btn btn-secondary">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    async function askAI(button, index) {
        const responseArea = document.getElementById(`ai-response-${index}`);
        const rawData = document.getElementById(`data-${index}`).textContent;
        const questionData = JSON.parse(rawData);

        // UIã®çŠ¶æ…‹ã‚’æ›´æ–°
        button.disabled = true;
        button.innerText = "â³ AIãŒè€ƒãˆä¸­...";
        responseArea.style.display = "block";
        responseArea.innerHTML = '<div class="spinner-border spinner-border-sm text-warning" role="status"></div> ã‚ã‹ã‚Šã‚„ã™ãè§£èª¬ã‚’ä½œæˆã—ã¦ã„ã¾ã™...';

        try {
            const response = await fetch('/ai_explain', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(questionData)
            });

            const result = await response.json();

            if (result.explanation) {
                // æ”¹è¡Œã‚’HTMLã®æ”¹è¡Œã‚¿ã‚°ã«å¤‰æ›ã—ã¦è¡¨ç¤º
                responseArea.innerHTML = `<strong>ğŸ¤– AIè¬›å¸«ã®æ·±æ˜ã‚Šè§£èª¬:</strong><br>${(result.explanation || '').replace(/\n/g, '<br>')}`;
            } else {
                responseArea.innerText = "ã‚¨ãƒ©ãƒ¼: è§£èª¬ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
            }
        } catch (error) {
            console.error("AI Error:", error);
            responseArea.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ç½®ã„ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ã€‚";
        } finally {
            button.disabled = false;
            button.innerText = "âœ¨ AIè¬›å¸«ã«è©³ã—ãèã";
        }
    }
    </script>
</body>
</html>